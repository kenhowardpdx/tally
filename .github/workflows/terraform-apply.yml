name: Terraform Apply

on:
    push:
        branches: [main]
        paths:
            - 'infra/**/*.tf'
            - '.github/workflows/terraform-apply.yml'

env:
    TF_VERSION: '1.5.0'
    AWS_REGION: 'us-east-1'

jobs:
    terraform-apply:
        name: Apply Terraform Changes
        runs-on: ubuntu-latest
        
        defaults:
            run:
                working-directory: infra
        
        permissions:
            contents: read
            id-token: write
        
        steps:
            - name: Setup Terraform Environment
              uses: ./.github/actions/setup-terraform
              with:
                  aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}
                  aws-region: ${{ env.AWS_REGION }}
                  terraform-version: ${{ env.TF_VERSION }}
                  working-directory: ./infra
            
            - name: Terraform Format Check
              run: terraform fmt -check
            
            - name: Terraform Init
              run: terraform init
              env:
                  TF_VAR_environment: production
            
            - name: Terraform Validate
              run: terraform validate
            
            - name: Terraform Plan
              run: terraform plan -out=tfplan
              env:
                  TF_VAR_environment: production
            
            - name: Terraform Apply
              run: terraform apply -auto-approve tfplan
              env:
                  TF_VAR_environment: production