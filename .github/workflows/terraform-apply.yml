name: Terraform Apply

on:
  push:
    branches:
      - main
    paths:
      - 'infra/**/*.tf'
      - 'infra/**/*.tfvars'
      - 'infra/**/*.hcl'

# Prevent multiple terraform applies from running simultaneously
concurrency:
  group: terraform-apply-production
  cancel-in-progress: false

jobs:
  terraform-apply:
    name: Apply Infrastructure Changes
    runs-on: ubuntu-latest
    
    # Minimal required permissions for security
    permissions:
      contents: read
      id-token: write  # Required for OIDC
    
    defaults:
      run:
        working-directory: ./infra
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: terraform-apply-${{ github.run_id }}
          aws-region: us-west-2
      
      - name: Validate Environment and Backend Configuration
        run: |
          echo "ğŸ” Validating environment and configuration..."
          
          # Validate required environment variables
          echo "ğŸ“‹ Checking required environment variables..."
          if [ -z "$TF_VAR_environment" ]; then
            echo "âŒ TF_VAR_environment is not set"
            exit 1
          fi
          echo "âœ… Environment: $TF_VAR_environment"
          
          # Validate AWS credentials are configured
          echo "ğŸ” Validating AWS credentials..."
          aws sts get-caller-identity > /dev/null
          if [ $? -ne 0 ]; then
            echo "âŒ AWS credentials not properly configured"
            exit 1
          fi
          echo "âœ… AWS credentials validated"
          
          # Check backend configuration
          echo "ğŸ—„ï¸ Checking backend configuration..."
          if [ -f backend.conf.example ]; then
            if [ ! -f backend.conf ]; then
              echo "âŒ backend.conf not found. Please create it from backend.conf.example"
              exit 1
            fi
            echo "âœ… Backend configuration found"
          fi
          
          # Validate Terraform files syntax
          echo "ğŸ“ Checking Terraform syntax..."
          terraform fmt -check -recursive
          if [ $? -ne 0 ]; then
            echo "âš ï¸ Terraform files are not properly formatted"
            echo "ğŸ’¡ Run 'terraform fmt -recursive' to fix formatting"
          else
            echo "âœ… Terraform files are properly formatted"
          fi
        env:
          TF_VAR_environment: production
      
      - name: Terraform Init
        run: |
          echo "ğŸ”§ Initializing Terraform..."
          terraform init -input=false
          if [ $? -ne 0 ]; then
            echo "âŒ Terraform init failed!"
            exit 1
          fi
          echo "âœ… Terraform initialized successfully"
      
      - name: Terraform Validate
        run: |
          echo "ğŸ” Validating Terraform configuration..."
          terraform validate
          if [ $? -ne 0 ]; then
            echo "âŒ Terraform validation failed!"
            exit 1
          fi
          echo "âœ… Terraform configuration is valid"
      
      - name: Terraform Plan
        id: plan
        run: |
          echo "ğŸ“‹ Creating Terraform execution plan..."
          terraform plan -input=false -out=tfplan -detailed-exitcode
          PLAN_EXIT_CODE=$?
          
          if [ $PLAN_EXIT_CODE -eq 1 ]; then
            echo "âŒ Terraform plan failed!"
            exit 1
          elif [ $PLAN_EXIT_CODE -eq 2 ]; then
            echo "ğŸ“ Changes detected in plan"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… No changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
        env:
          TF_VAR_environment: production
      
      - name: Terraform Apply
        if: steps.plan.outputs.has_changes == 'true'
        run: |
          echo "ğŸš€ Applying Terraform changes..."
          terraform apply -auto-approve -input=false tfplan
          if [ $? -ne 0 ]; then
            echo "âŒ Terraform apply failed!"
            echo "ğŸ§¹ Cleaning up temporary files..."
            rm -f tfplan
            exit 1
          fi
          echo "âœ… Terraform apply completed successfully!"
        env:
          TF_VAR_environment: production
      
      - name: Skip Apply (No Changes)
        if: steps.plan.outputs.has_changes == 'false'
        run: |
          echo "â„¹ï¸ No infrastructure changes detected, skipping apply"
          echo "ğŸ¯ Current infrastructure is already up to date"
      
      - name: Display Infrastructure Summary
        if: success() && steps.plan.outputs.has_changes == 'true'
        run: |
          echo "ğŸ‰ Infrastructure deployment completed successfully!"
          echo ""
          echo "ğŸ“Š Deployment Summary:"
          echo "â”œâ”€â”€ Environment: production"
          echo "â”œâ”€â”€ Region: us-west-2"
          echo "â”œâ”€â”€ Terraform Version: $(terraform version -json | jq -r '.terraform_version')"
          echo "â””â”€â”€ Applied at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          # Display outputs if any exist
          if terraform output > /dev/null 2>&1; then
            echo "ğŸ“‹ Infrastructure Outputs:"
            terraform output -json | jq -r 'to_entries[] | "â”œâ”€â”€ \(.key): \(.value.value)"'
          else
            echo "ğŸ“‹ No outputs defined"
          fi
          echo ""
          
          # Display resource count
          echo "ğŸ—ï¸ Infrastructure Resources:"
          terraform show -json | jq -r '.values.root_module.resources | length' | xargs -I {} echo "â”œâ”€â”€ Total resources: {}"
          echo "â””â”€â”€ State file: $(terraform show -json | jq -r '.terraform_version // "unknown"')"
      
      - name: Display Success Message (No Changes)
        if: success() && steps.plan.outputs.has_changes == 'false'
        run: |
          echo "âœ¨ Infrastructure verification completed!"
          echo "ğŸ¯ No changes were needed - infrastructure is up to date"
          echo "ğŸ“Š Current state matches desired configuration"
      
      - name: Cleanup on Failure
        if: failure()
        run: |
          echo "âŒ Terraform apply failed!"
          echo "ğŸ§¹ Cleaning up temporary files..."
          rm -f tfplan
          echo "ğŸ’¡ Check the logs above for detailed error information"
